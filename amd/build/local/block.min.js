define("block_sharing_cart/local/block",["exports","core/reactive","core/str","core_courseformat/courseeditor","../app/factory"],(function(_exports,_reactive,_str,_courseeditor,_factory){var obj;function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_factory=(obj=_factory)&&obj.__esModule?obj:{default:obj};class Block extends _reactive.BaseComponent{constructor(){super(...arguments),_defineProperty(this,"course",void 0),_defineProperty(this,"block",void 0),_defineProperty(this,"queue",void 0)}create(descriptor){var _descriptor$canBackup,_descriptor$canAnonym,_descriptor$canBackup2,_descriptor$showShari;this.name="sharing_cart_block",this.selectors={COPY_SECTION_CONTAINER:"#copy_section_container"},this.canBackupUserdata=null!==(_descriptor$canBackup=descriptor.canBackupUserdata)&&void 0!==_descriptor$canBackup&&_descriptor$canBackup,this.canAnonymizeUserdata=null!==(_descriptor$canAnonym=descriptor.canAnonymizeUserdata)&&void 0!==_descriptor$canAnonym&&_descriptor$canAnonym,this.canBackup=null!==(_descriptor$canBackup2=descriptor.canBackup)&&void 0!==_descriptor$canBackup2&&_descriptor$canBackup2,this.showSharingCartBasket=null!==(_descriptor$showShari=descriptor.showSharingCartBasket)&&void 0!==_descriptor$showShari&&_descriptor$showShari}static init(target,canBackupUserdata,canAnonymizeUserdata,canBackup,showSharingCartBasket){return new this({element:document.getElementById(target),reactive:(0,_courseeditor.getCurrentCourseEditor)(),canBackupUserdata:canBackupUserdata,canAnonymizeUserdata:canAnonymizeUserdata,canBackup:canBackup,showSharingCartBasket:showSharingCartBasket})}stateReady(){this.baseFactory=_factory.default.make();const{course:course,block:block,queue:queue}=this.baseFactory.block().eventHandler().onLoad(this.canBackupUserdata,this.canAnonymizeUserdata,this.canBackup,this.showSharingCartBasket);this.course=course,this.block=block,this.queue=queue;const courseContent=document.querySelector(".course-content");if(courseContent){courseContent.querySelectorAll('[data-for="section"]').forEach((sectionElement=>{const section=this.reactive.state.section.get(sectionElement.dataset.id);this._refreshSection({element:section})}));courseContent.querySelectorAll('[data-for="cmitem"]').forEach((courseModuleElement=>{const courseModule=this.reactive.state.cm.get(courseModuleElement.dataset.id);this._refreshCourseModule({element:courseModule})}))}const showCopySectionInBlockSegment=this.getElement(this.selectors.COPY_SECTION_CONTAINER);if(showCopySectionInBlockSegment){this._refreshCopySectionOptions();const select=showCopySectionInBlockSegment.querySelector("select");showCopySectionInBlockSegment.querySelector("button").addEventListener("click",(async()=>{await this.block.addSectionBackupToSharingCart(select.value)}))}}getWatchers(){return[{watch:"section:created",handler:this._refreshSection},{watch:"section:updated",handler:this._refreshSection},{watch:"section.dragging:created",handler:this._onDraggingSection},{watch:"section.dragging:updated",handler:this._onDraggingSection},{watch:"cm.dragging:created",handler:this._onDraggingCourseModule},{watch:"cm.dragging:updated",handler:this._onDraggingCourseModule},{watch:"cm:created",handler:this._refreshCourseModule},{watch:"cm:updated",handler:this._refreshCourseModule}]}async getBackupToSharingCartButton(){return this._sharingCartButton||(this._sharingCartButton=await this.baseFactory.moodle().template().createElementFromTemplate("block_sharing_cart/block/course/add_to_sharing_cart_button",{})),this._sharingCartButton.cloneNode(!0)}async _refreshCopySectionOptions(){const showCopySectionInBlockSegment=this.getElement(this.selectors.COPY_SECTION_CONTAINER);if(!showCopySectionInBlockSegment)return;const select=showCopySectionInBlockSegment.querySelector("select"),selectedValue=select.value,noCourseModulesInSections=await(0,_str.get_string)("no_course_modules_in_section","block_sharing_cart"),div=document.createElement("div"),option=document.createElement("option");option.disabled=!0,option.text=await(0,_str.get_string)("choosedots","core"),div.appendChild(option),this.reactive.state.section.forEach((section=>{const option=document.createElement("option");0===section.cmlist.length&&(option.disabled=!0,option.title=noCourseModulesInSections),option.value=section.id,option.text=section.title,option.selected=Number.parseInt(section.id)===Number.parseInt(selectedValue),div.appendChild(option)})),select.innerHTML=div.innerHTML}async _refreshSection(_ref){let{element:element}=_ref;if(this._refreshCopySectionOptions(),this.showSharingCartBasket&&this.canBackup){let backupButton=await this.getBackupToSharingCartButton();const sectionTitle=document.querySelector('.course-content [data-for="section_title"] .inplaceeditable[data-itemid="'+element.id+'"]');if(sectionTitle){sectionTitle.parentElement.querySelector(".add_to_sharing_cart")||(sectionTitle.after(backupButton),backupButton.addEventListener("click",(e=>{e.currentTarget.classList.contains("disabled")||this.block.addSectionBackupToSharingCart(element.id)}))),backupButton=sectionTitle.parentElement.querySelector(".add_to_sharing_cart");const disabled=0===element.cmlist.length;backupButton.classList.toggle("disabled",disabled),backupButton.title=disabled?await(0,_str.get_string)("no_course_modules_in_section_description","block_sharing_cart"):""}}}async _refreshCourseModule(_ref2){let{element:element}=_ref2;if(this.showSharingCartBasket&&this.canBackup){const backupButton=await this.getBackupToSharingCartButton(),courseModuleActionMenu=document.querySelector('.course-content .cm_action_menu[data-cmid="'+element.id+'"]');if(!courseModuleActionMenu)return void setTimeout((()=>this._refreshCourseModule({element:element})),100);courseModuleActionMenu.querySelector(".add_to_sharing_cart")||(courseModuleActionMenu.append(backupButton),backupButton.addEventListener("click",this.block.addCourseModuleBackupToSharingCart.bind(this.block,element.id)))}}async _onDraggingSection(_ref3){let{element:element}=_ref3;element.dragging?(this.block.getElement().classList.add("dragging_item"),this.block.setDraggedSectionId(element.id)):(this.block.getElement().classList.remove("dragging_item"),this.block.setDraggedSectionId(null))}async _onDraggingCourseModule(_ref4){let{element:element}=_ref4;element.dragging?(this.block.getElement().classList.add("dragging_item"),this.block.setDraggedCourseModuleId(element.id)):(this.block.getElement().classList.remove("dragging_item"),this.block.setDraggedCourseModuleId(null))}}return _exports.default=Block,_exports.default}));

//# sourceMappingURL=block.min.js.map
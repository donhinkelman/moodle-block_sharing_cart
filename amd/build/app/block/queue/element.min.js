define("block_sharing_cart/app/block/queue/element",["exports","core_courseformat/courseeditor","core/ajax","core/toast","core/str"],(function(_exports,_courseeditor,_ajax,Toast,_str){var obj;function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _classPrivateFieldInitSpec(obj,privateMap,value){!function(obj,privateCollection){if(privateCollection.has(obj))throw new TypeError("Cannot initialize the same private elements twice on an object")}(obj,privateMap),privateMap.set(obj,value)}function _classPrivateFieldGet(receiver,privateMap){return function(receiver,descriptor){if(descriptor.get)return descriptor.get.call(receiver);return descriptor.value}(receiver,_classExtractFieldDescriptor(receiver,privateMap,"get"))}function _classPrivateFieldSet(receiver,privateMap,value){return function(receiver,descriptor,value){if(descriptor.set)descriptor.set.call(receiver,value);else{if(!descriptor.writable)throw new TypeError("attempted to set read only private field");descriptor.value=value}}(receiver,_classExtractFieldDescriptor(receiver,privateMap,"set"),value),value}function _classExtractFieldDescriptor(receiver,privateMap,action){if(!privateMap.has(receiver))throw new TypeError("attempted to "+action+" private field on non-instance");return privateMap.get(receiver)}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_ajax=(obj=_ajax)&&obj.__esModule?obj:{default:obj},Toast=function(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}newObj.default=obj,cache&&cache.set(obj,newObj);return newObj}(Toast);var _baseFactory=new WeakMap,_blockElement=new WeakMap,_element=new WeakMap,_reactive=new WeakMap,_loadQueuePromise=new WeakMap,_loadQueueToken=new WeakMap,_preventReload=new WeakMap;return _exports.default=class{constructor(baseFactory,blockElement,element){_classPrivateFieldInitSpec(this,_baseFactory,{writable:!0,value:void 0}),_classPrivateFieldInitSpec(this,_blockElement,{writable:!0,value:void 0}),_classPrivateFieldInitSpec(this,_element,{writable:!0,value:void 0}),_classPrivateFieldInitSpec(this,_reactive,{writable:!0,value:void 0}),_classPrivateFieldInitSpec(this,_loadQueuePromise,{writable:!0,value:null}),_classPrivateFieldInitSpec(this,_loadQueueToken,{writable:!0,value:null}),_classPrivateFieldInitSpec(this,_preventReload,{writable:!0,value:!1}),_classPrivateFieldSet(this,_baseFactory,baseFactory),_classPrivateFieldSet(this,_blockElement,blockElement),_classPrivateFieldSet(this,_element,element),_classPrivateFieldSet(this,_reactive,(0,_courseeditor.getCurrentCourseEditor)()),this.tryReloadQueue(!0),setInterval((()=>{this.tryReloadQueue()}),4e3)}getQueueItems(){return _classPrivateFieldGet(this,_element).querySelectorAll(".queue-item")}tryReloadQueue(){!1===(arguments.length>0&&void 0!==arguments[0]&&arguments[0])&&0===this.getQueueItems().length||(null===_classPrivateFieldGet(this,_loadQueuePromise)?(_classPrivateFieldSet(this,_loadQueueToken,{}),_classPrivateFieldSet(this,_loadQueuePromise,this.loadQueue(!1,_classPrivateFieldGet(this,_loadQueueToken))),_classPrivateFieldGet(this,_loadQueuePromise).then((()=>{_classPrivateFieldSet(this,_loadQueuePromise,null),_classPrivateFieldSet(this,_loadQueueToken,null)})).catch((()=>{_classPrivateFieldSet(this,_loadQueueToken,null),_classPrivateFieldSet(this,_loadQueuePromise,null)}))):_classPrivateFieldGet(this,_loadQueuePromise).then((()=>{this.tryReloadQueue()})).catch((()=>{this.tryReloadQueue()})))}async loadQueue(){let showSpinner=arguments.length>0&&void 0!==arguments[0]&&arguments[0],token=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return new Promise((async(resolve,reject)=>{token.abort=()=>{reject()};const oldChildren=_classPrivateFieldGet(this,_element).children,oldQueueItemsCount=this.getQueueItems().length;showSpinner&&(_classPrivateFieldGet(this,_element).innerHTML='<i class="fa fa-spinner"></i>');const elements=await _classPrivateFieldGet(this,_baseFactory).moodle().template().createElementsFromFragment("block_sharing_cart","item_queue",M.cfg.contextid,{}),queueItems=elements.filter((element=>element instanceof Element&&element.classList.contains("queue-item")));if(oldQueueItemsCount>queueItems.length){const removedElements=Array.from(oldChildren).filter((element=>void 0===queueItems.find((el=>el.dataset.id===element.dataset.id)))),sectionIds=[];removedElements.forEach((element=>{const sectionId=element.dataset.toSectionId;sectionId&&-1===sectionIds.indexOf(sectionId)&&sectionIds.push(sectionId)})),sectionIds.length>0&&_classPrivateFieldGet(this,_reactive).dispatch("sectionState",sectionIds).then((()=>{Toast.add((0,_str.get_string)("you_may_need_to_reload_the_course_warning","block_sharing_cart"),{closeButton:!0,autohide:!0,type:"warning"})}))}_classPrivateFieldGet(this,_element).innerHTML="",queueItems.forEach((element=>{const runNowButton=element.querySelector("button.btn");runNowButton&&runNowButton.addEventListener("click",(()=>{const taskId=element.dataset.id;runNowButton.disabled=!0,_classPrivateFieldSet(this,_preventReload,!0),null!==_classPrivateFieldGet(this,_loadQueueToken)&&_classPrivateFieldGet(this,_loadQueueToken).abort(),_ajax.default.call([{methodname:"block_sharing_cart_run_task_now",args:{task_id:taskId}}]),setTimeout((()=>{_classPrivateFieldSet(this,_preventReload,!1),this.tryReloadQueue(!0)}),2e3)}),{once:!0})})),elements.forEach((element=>{_classPrivateFieldGet(this,_element).appendChild(element)})),resolve()}))}},_exports.default}));

//# sourceMappingURL=element.min.js.map
{"version":3,"file":"element.min.js","sources":["../../../../src/app/block/course/element.js"],"sourcesContent":["import {getCurrentCourseEditor} from \"core_courseformat/courseeditor\";\n\n/**\n * @typedef {import(\"core_courseformat/factory\").BaseFactory} BaseFactory\n */\n\n/**\n * @typedef Section\n * @property {number} id\n * @property {number} section\n * @property {number} number\n * @property {string} title\n * @property {boolean} hassummary\n * @property {string} rawtitle\n * @property {string[]} cmlist\n * @property {boolean} visible\n * @property {string} sectionurl\n * @property {boolean} current\n * @property {boolean} indexcollapsed\n * @property {boolean} contentcollapsed\n * @property {boolean} hasrestrictions\n * @property {boolean} bulkeditable\n * @property {string|null} component\n * @property {number|null} itemid\n */\n\n/**\n * @typedef CourseModule\n * @property {number} id\n * @property {string} anchor\n * @property {string} name\n * @property {boolean} visible\n * @property {boolean} stealth\n * @property {string} sectionid\n * @property {number} sectionnumber\n * @property {boolean} uservisible\n * @property {boolean} hascmrestrictions\n * @property {string} modname\n * @property {number} indent\n * @property {number} groupmode\n * @property {string} module\n * @property {string} plugin\n * @property {boolean} delegatesection\n * @property {boolean} accessvisible\n * @property {string} url\n * @property {boolean} istrackeduser\n * @property {boolean} allowstealth\n */\n\nexport default class CourseElement {\n    /**\n     * @type {BaseFactory}\n     */\n    #baseFactory;\n\n    /**\n     * @type {BlockElement}\n     */\n    #blockElement;\n\n    /**\n     * @type {HTMLElement}\n     */\n    #element;\n\n    /**\n     * @type {HTMLElement|null}\n     */\n    #clipboard = null;\n\n    /**\n     * @type {AbortController}\n     */\n    #clipboardTargetListenerAbortController = new AbortController();\n\n    /**\n     * @type {import(\"core_courseformat/local/courseeditor/courseeditor\").CourseEditor}\n     */\n    reactive;\n\n    /**\n     * @param {BaseFactory} baseFactory\n     * @param {BlockElement} blockElement\n     * @param {HTMLElement} element\n     */\n    constructor(baseFactory, blockElement, element) {\n        this.#baseFactory = baseFactory;\n        this.#blockElement = blockElement;\n        this.#element = element;\n        this.reactive = getCurrentCourseEditor();\n    }\n\n    async renderClipboard() {\n        this.#clipboard = await this.#baseFactory.moodle().template().createElementFromTemplate(\n            'block_sharing_cart/block/course/clipboard',\n            {}\n        );\n\n        this.#element.prepend(this.#clipboard);\n\n        const clearClipboardButton = this.#clipboard.querySelector('[data-action=\"clear-clipboard\"]');\n        clearClipboardButton.addEventListener(\n            'click',\n            this.onClearClipboard.bind(this)\n        );\n    }\n\n    /**\n     * @param {Event} e\n     */\n    onClearClipboard(e) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        this.clearClipboard();\n    }\n\n    clearClipboard() {\n        this.#clipboard.classList.add('d-none');\n        this.clearClipboardTargets();\n\n        this.#blockElement.clearClipboard();\n    }\n\n    /**\n     * @param {ItemElement} item\n     */\n    updateClipboard(item) {\n        this.#clipboard.classList.add('d-none');\n\n        const clipboardItemInfo = this.#clipboard.querySelector('.info');\n        clipboardItemInfo.innerHTML = item.getItemInfo().innerHTML;\n\n        this.#clipboard.classList.remove('d-none');\n    }\n\n    /**\n     * @param {ItemElement} item\n     */\n    async updateClipboardTargets(item) {\n        const element = await this.#baseFactory.moodle().template().createElementFromTemplate(\n            'block_sharing_cart/block/course/clipboard_target',\n            {}\n        );\n\n        this.#clipboardTargetListenerAbortController.abort();\n        this.#clipboardTargetListenerAbortController = new AbortController();\n\n        this.#element.querySelectorAll('[data-for=\"cmlist\"]').forEach((section) => {\n            const clipboardTarget = section.querySelector('.clipboard_target') ?? element.cloneNode(true);\n\n            section.prepend(clipboardTarget);\n\n            const sectionId = section.closest('[data-for=\"section\"]').dataset.id;\n\n            clipboardTarget.classList.remove('hidden');\n            clipboardTarget.parentElement.classList.remove('hidden');\n            clipboardTarget.addEventListener(\n                'click',\n                this.#blockElement.confirmImportBackupFromSharingCart.bind(this.#blockElement, item, sectionId),\n                {\n                    signal: this.#clipboardTargetListenerAbortController.signal\n                }\n            );\n        });\n    }\n\n    /**\n     * @param {Number} sectionId\n     * @returns {String}\n     */\n    getSectionName(sectionId) {\n        const section = this.reactive.state.section.get(sectionId);\n\n        return section.title ?? 'Unknown';\n    }\n\n    /**\n     * @param {Number} sectionId\n     * @returns {Array<string>}\n     */\n    getSectionCourseModules(sectionId) {\n        return this.reactive.state.section.get(sectionId).cmlist;\n    }\n\n    /**\n     * @param {number|string} courseModuleId\n     * @returns {CourseModule|null}\n     */\n    getCourseModule(courseModuleId) {\n        return this.reactive.state.cm.get(courseModuleId);\n    }\n\n    /**\n     * @param {String} courseModuleId\n     * @returns {String}\n     */\n    getCourseModuleName(courseModuleId) {\n        const courseModule = this.reactive.state.cm.get(courseModuleId);\n\n        return courseModule.name ?? 'Unknown';\n    }\n\n    /**\n     * @param {number|string} sectionId\n     * @param {string} type\n     * @returns {boolean}\n     */\n    hasSectionCourseModuleType(sectionId, type) {\n        let cms = this.getSectionCourseModules(sectionId);\n        if (!cms) {\n            return false;\n        }\n        for (const id of cms) {\n            if (this.isCourseModuleTypeById(id, type)) {\n                return true;\n            }\n        }\n        return false;\n    }\n\n    /**\n     * @param {number|string} courseModuleId\n     * @param {string} type\n     * @returns {boolean}\n     */\n    isCourseModuleTypeById(courseModuleId, type) {\n        const courseModule = this.getCourseModule(courseModuleId);\n        if (!courseModule) {\n            return false;\n        }\n        return courseModule?.module === type;\n    }\n\n    /**\n     * @returns {NodeListOf<HTMLElement>}\n     */\n    getClipboardTargets() {\n        return this.#element.querySelectorAll('.clipboard_target');\n    }\n\n    clearClipboardTargets() {\n        this.getClipboardTargets().forEach((target) => {\n            target.remove();\n        });\n    }\n\n    /**\n     * @param {ItemElement} item\n     */\n    async setClipboard(item) {\n        if (!this.#clipboard) {\n            await this.renderClipboard();\n        }\n\n        this.updateClipboard(item);\n        await this.updateClipboardTargets(item);\n    }\n}\n"],"names":["constructor","baseFactory","blockElement","element","AbortController","reactive","_classPrivateFieldGet","moodle","template","createElementFromTemplate","prepend","this","querySelector","addEventListener","onClearClipboard","bind","e","preventDefault","stopPropagation","clearClipboard","classList","add","clearClipboardTargets","updateClipboard","item","innerHTML","getItemInfo","remove","abort","querySelectorAll","forEach","section","clipboardTarget","cloneNode","sectionId","closest","dataset","id","parentElement","confirmImportBackupFromSharingCart","signal","getSectionName","state","get","title","getSectionCourseModules","cmlist","getCourseModule","courseModuleId","cm","getCourseModuleName","name","hasSectionCourseModuleType","type","cms","isCourseModuleTypeById","courseModule","module","getClipboardTargets","target","renderClipboard","updateClipboardTargets"],"mappings":"y5CAqFIA,YAAYC,YAAaC,aAAcC,iTAjB1B,kGAK6B,IAAIC,0MAatBH,sDACCC,kDACLC,cACXE,UAAW,8GAIQC,yCAAkBC,SAASC,WAAWC,0BAC1D,4CACA,0CAGUC,8BAAQC,kBAEOL,uCAAgBM,cAAc,mCACtCC,iBACjB,QACAF,KAAKG,iBAAiBC,KAAKJ,OAOnCG,iBAAiBE,GACbA,EAAEC,iBACFD,EAAEE,uBAEGC,iBAGTA,wDACoBC,UAAUC,IAAI,eACzBC,kEAEcH,iBAMvBI,gBAAgBC,6CACIJ,UAAUC,IAAI,UAEJf,uCAAgBM,cAAc,SACtCa,UAAYD,KAAKE,cAAcD,iDAEjCL,UAAUO,OAAO,uCAMRH,YACnBrB,cAAgBG,yCAAkBC,SAASC,WAAWC,0BACxD,mDACA,wEAGyCmB,2EACE,IAAIxB,sDAErCyB,iBAAiB,uBAAuBC,SAASC,0CACrDC,8CAAkBD,QAAQnB,cAAc,4EAAwBT,QAAQ8B,WAAU,GAExFF,QAAQrB,QAAQsB,uBAEVE,UAAYH,QAAQI,QAAQ,wBAAwBC,QAAQC,GAElEL,gBAAgBZ,UAAUO,OAAO,UACjCK,gBAAgBM,cAAclB,UAAUO,OAAO,UAC/CK,gBAAgBnB,iBACZ,QACAP,0CAAmBiC,mCAAmCxB,2BAAKJ,oBAAoBa,KAAMU,WACrF,CACIM,OAAQlC,oEAA6CkC,YAUrEC,eAAeP,4DACKvB,KAAKN,SAASqC,MAAMX,QAAQY,IAAIT,WAEjCU,+CAAS,UAO5BC,wBAAwBX,kBACbvB,KAAKN,SAASqC,MAAMX,QAAQY,IAAIT,WAAWY,OAOtDC,gBAAgBC,uBACLrC,KAAKN,SAASqC,MAAMO,GAAGN,IAAIK,gBAOtCE,oBAAoBF,yEACKrC,KAAKN,SAASqC,MAAMO,GAAGN,IAAIK,gBAE5BG,sDAAQ,UAQhCC,2BAA2BlB,UAAWmB,UAC9BC,IAAM3C,KAAKkC,wBAAwBX,eAClCoB,WACM,MAEN,MAAMjB,MAAMiB,OACT3C,KAAK4C,uBAAuBlB,GAAIgB,aACzB,SAGR,EAQXE,uBAAuBP,eAAgBK,YAC7BG,aAAe7C,KAAKoC,gBAAgBC,wBACrCQ,eAGEA,MAAAA,oBAAAA,aAAcC,UAAWJ,KAMpCK,6BACWpD,qCAAcuB,iBAAiB,qBAG1CP,6BACSoC,sBAAsB5B,SAAS6B,SAChCA,OAAOhC,+BAOIH,4BACVb,wBACKA,KAAKiD,uBAGVrC,gBAAgBC,YACfb,KAAKkD,uBAAuBrC"}
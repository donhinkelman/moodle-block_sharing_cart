define ("block_sharing_cart/script",["jquery","core/modal_factory","core/modal_events"],function(a,b,c){return{init:function init(){a(document).ready(function(){function d(a){return M.str.block_sharing_cart[a]||M.str.moodle[a]}function f(a,b){var c=M.cfg.wwwroot+"/blocks/sharing_cart/"+a+".php";if(b){var d=[];for(var e in b){d.push(e+"="+encodeURIComponent(b[e]))}c+="?"+d.join("&")}return c}function g(f){if(f.checkbox){f.body+="<div class=\"modal-checbox-wrapper\"><input type=\"checkbox\" id=\"modal-checkbox\" class=\"modal-checkbox\" checked><label for=\"modal-checkbox\">"+d("modal_checkbox")+"</label></div>"}f.body+="<p class=\"alert alert-danger mt-3\">"+d("backup_heavy_load_warning_message")+"</p>";b.create({type:b.types.SAVE_CANCEL,title:f.title,body:f.body}).done(function(b){b.setSaveButtonText(f.save_button);b.getRoot().on(c.save,function(b){var c={checkbox:a(b.target).find(".modal-checkbox").is(":checked")};f.next(c)});b.getRoot().on(c.hidden,function(){a("body").removeClass("modal-open")});b.show()})}function h(a){var b="",c=a.find("h3.sectionname .inplaceeditable");if(c.length){b=c.data("value")}return b}function i(b,c,e,h){(function(c){a.post(f("rest"),b,function(a){c(a)},"text").fail(function(a){j(a)})})(function(a){var f=!1;if("1"===a){f=!0}g({title:c,body:e,save_button:d("modal_confirm_backup"),checkbox:f,next:function next(a){if(!0===h){s(b.sectionid,b.sectionnumber,b.courseid,a.checkbox)}else{r(b.cmid,a.checkbox)}}})})}var t={backup:{css:"editing_backup",iconClass:"fa fa-frown-o"},movedir:{css:"editing_right",iconClass:"fa fa-arrow-right"},move:{css:"editing_move_",iconClass:"fa fa-arrows-v"},edit:{css:"editing_update",iconClass:"fa fa-pencil"},cancel:{css:"editing_cancel",iconClass:"fa fa-ban"},delete:{css:"editing_update",iconClass:"fa fa-trash"},restore:{css:"editing_restore",iconClass:"fa fa-clone"},"dir-open":{iconClass:"fa fa-folder-open-o"},"dir-closed":{iconClass:"fa fa-folder-o"}},u=a(".block_sharing_cart"),v=new function(){var b=a("body");this.id=b.attr("class").match(/course-(\d+)/)[1];this.is_frontpage=b.hasClass("pagelayout-frontpage")};function j(a){try{var b=JSON.parse(a.responseText);new M.core.exception({name:d("pluginname")+" - "+d("error"),message:b.message})}catch(b){new M.core.exception({name:d("pluginname")+" - "+d("error"),message:a.responseText})}}function k(){var a=u.find(".menubar .dropdown .dropdown-menu");return a.length}function l(a,b,c){var e=new Date;e.setTime(e.getTime()+c);var d="expires="+e.toUTCString();document.cookie=a+"="+b+";"+d+""}function m(a){var b=document.cookie.match("(^|;)\\s*"+a+"\\s*=\\s*([^;]+)");return b?b.pop():""}function n(b){var c=a("<i/>").attr("alt",d(b)).attr("class",t[b].iconClass);return a("<a href=\"javascript:void(0)\"/>").addClass(t[b].css).attr("title",d(b)).append(c)}function o(){var b=a("<div class=\"block_spinner\"><i class=\"fa fa-circle-o-notch fa-spin fa-2x\"></i></div>");a("section.block_sharing_cart").append(b);return b}function p(b){var c=a("<i class=\"fa fa-circle-o-notch fa-spin node_spinner\"></i>");b.append(c);return c}a(document).on("click","a.restore",function(){o()});function q(){a.post(f("rest"),{action:"render_tree",courseid:v.id},function(b){u.find(".tree").replaceWith(a(b));a.init_item_tree()},"html").fail(function(a){j(a)})}function r(b,c){var d=a("#module-"+b+" .actions");if(!d.length){d=a("[data-owner=\"#module-"+b+"\"]")}var e=o(),g=p(d);a.post(f("rest"),{action:"backup",cmid:b,userdata:c,sesskey:M.cfg.sesskey,courseid:v.id},function(){q()}).fail(function(a){j(a)}).always(function(){g.hide();e.hide()})}function s(b,c,d,e){var g=a("span.inplaceeditable[data-itemtype=sectionname][data-itemid="+b+"]"),i=g.closest("li.section.main"),k=i.attr("aria-label");if(null===k){k=a("#region-main .section_action_menu[data-sectionid='"+b+"']").parent().parent().find("h3.sectionname").text()+""}var l=h(i);k=""!==l?l:k;var m=o(),n=p(g);a.post(f("rest"),{action:"backup_section",sectionid:b,sectionnumber:c,courseid:d,sectionname:k,userdata:e,sesskey:M.cfg.sesskey},function(){q()}).fail(function(a){j(a)}).always(function(){m.hide();n.hide()})}var w=new function(){var f=m("block_sharing_cart-dirs").split(",").map(function(a){return parseInt(a)});function b(){var a=new Date;a.setDate(a.getDate()+30);l("block_sharing_cart-dirs",f.join(","),a)}function c(a,b){var c=b?"dir-open":"dir-closed",d=t[c].iconClass;a.find("> div i.icon").attr("class","icon "+d);a.find("> ul.list")[b?"show":"hide"]()}function d(d){var e=a(d.target).closest("li.directory"),g=e.attr("id").match(/(\d+)$/)[1],h="none"===e.find("> ul.list").css("display");c(e,h);f[g]=h?1:0;b()}this.init=function(){var b=0;u.find("li.directory").each(function(e,g){var h=a(g);h.attr("id","block_sharing_cart-dir-"+b);if(b>=f.length){f.push(0)}else if(f[b]){c(h,!0)}h.find("> div div.toggle-wrapper").css("cursor","pointer").on("click",function(a){d(a)});b++})};this.reset=function(){f=[];this.init();b()}},x=new function(){var b=null,c=[];this.hide=function(){if(null!==b){var d=b.closest(".commands");b.remove();b=null;d.closest("li.activity").css("opacity",1);d.find("a").each(function(){a(this).show()});a.each(c,function(a,b){b.remove()});c=[]}};this.show=function(e){this.hide();function g(b){var c=a(b.target).closest("a").attr("class").match(/move-(\d+)-to-(\d+)/),d=c[1],e=c[2],g=o();a.post(f("rest"),{action:"move",item_id:d,area_to:e,sesskey:M.cfg.sesskey},function(){q()}).fail(function(a){j(a)}).always(function(){g.hide()})}var i=u.find("#block_sharing_cart-item-"+e),k=i.next(),l=i.closest("ul"),m=0;if(k.length){m=k.attr("id").match(/item-(\d+)$/)[1]}function h(b,c){var e=a("<a href=\"javascript:void(0)\"/>").addClass("move-"+b+"-to-"+c).attr("title",d("movehere")).append(a("<p>"+d("clicktomove")+"</p>").attr("alt",d("movehere"))),f=a("<li class=\"activity move-to\"/>").append(e);e.on("click",function(a){g(a)});return f}l.find("> li.activity").each(function(d,f){var g=a(f),i=g.attr("id").match(/item-(\d+)$/)[1];if(i===e){b=n("cancel","t/left");b.on("click",function(){x.hide()});var j=g.find(".commands");j.find("a").each(function(){a(this).hide()});j.append(b);g.css("opacity",.5)}else if(i!==m){var k=h(e,i);g.before(k);c.push(k)}},this);if(k){var p=h(e,0);l.append(p);c.push(p)}}},y=new function(){this.is_directory=null;var c=null,e=[];function b(b,c){var g="",h=a("#copy-section-form").data("in-section");if(y.is_directory){g=f("restore",{directory:!0,path:b,course:v.id,section:c,in_section:h,sesskey:M.cfg.sesskey})}else{g=f("restore",{directory:!1,id:b,course:v.id,section:c,in_section:h,sesskey:M.cfg.sesskey})}var i=a("<a/>").attr("class","restore").attr("href",g).attr("title",d("copyhere")).append(a("<img class=\"move_target\"/>").attr("alt",d("copyhere")).attr("src",M.util.image_url("dropzone_arrow","block_sharing_cart")));e.push(i);return i}this.hide=function(){if(null!==c){c.remove();c=null;a.each(e,function(a,b){b.remove()});e=[]}};this.show=function(e){this.hide();var f=a("<span/>");if(this.is_directory){f.html(e).css("display","inline");f.prepend(a("<i/>").addClass("icon").attr("alt",e))}else{var g=u.find("#block_sharing_cart-item-"+e);f=a(g.find("div")[0].cloneNode(!0)).css("display","inline");f.attr("class",f.attr("class").replace(/mod-indent-\d+/,""));f.find(".commands").remove()}var h=n("cancel");h.on("click",this.hide);c=a("<div class=\"clipboard\"/>");c.append(d("clipboard")+": ").append(f).append(h);if(v.is_frontpage){var i=a(".sitetopic"),j=a(".block_site_main_menu");if(i){i.find("*").before(c)}else if(j){j.find(".content").before(c)}if(j){j.find(".footer").before(b(e,0))}if(i){i.find("ul.section").append(b(e,1))}}else{var k=a(".course-content");k.one("*").before(c);k.find(M.course.format.get_section_wrapper(null)).each(function(c,d){var f=a(d),g=f.attr("id").match(/(\d+)$/)[1];f.find("ul.section").first().append(b(e,g))},this)}}};a.get_plugin_name=function(){var a=u.find("h2");if(!a.length){a=u.find("h3");if(a.length){return a.html()}}else{return a.html()}return""};a.on_backup=function(b,c){var e=function(a){var b=a.closest("li.activity");if(b.length){return b.attr("id").match(/(\d+)$/)[1]}var c=a.closest(".commands"),d=c.attr("data-owner");if(d.length){return d.match(/(\d+)$/)[1]}return c.find("a.editing_delete").attr("href").match(/delete=(\d+)/)[1]}(a(b.target));i({action:"is_userdata_copyable",cmid:e},c,d("confirm_backup"),!1)};a.on_movedir=function(b){var d=a(b.target).closest(".commands"),e=d.closest("li.directory"),g=e.length?e.attr("directory-path"):"/",h=a(b.target).closest("li.activity").attr("id").match(/(\d+)$/)[1],k=[];u.find("li.directory").each(function(){k.push(a(this).attr("directory-path"))});var l=a("<form/>");l.attr("action","javascript:void(0)");function c(){var b=l.find("[name=\"to\"]").val(),c=o();a.post(f("rest"),{action:"movedir",item_id:h,folder_to:b,sesskey:M.cfg.sesskey},function(){q();w.reset()}).fail(function(a){j(a)}).always(function(){c.hide()})}l.submit(c);if(0===k.length){var m=a("<input class=\"form-control\" type=\"text\" name=\"to\"/>").val(g);setTimeout(function(){m.focus()},1);l.append(m)}else{k.unshift("/");for(var p=a("<select class=\"custom-select\" name=\"to\"/>"),r=0;r<k.length;r++){p.append(a("<option/>").val(k[r]).append(k[r]))}p.val(g);p.change(c);l.append(p);var s=n("edit");s.on("click",function(){var b=a("<input type=\"text\" name=\"to\"/>").val(g);p.remove();s.replaceWith(b);b.focus()});l.append(s)}var t=n("cancel");t.on("click",function(){l.remove();d.find("a").show()});l.append(t);d.find("a").each(function(){a(this).hide()});d.append(l)};a.on_move=function(b){var c=a(b.target).closest("li.activity"),d=c.attr("id").match(/(\d+)$/)[1];x.show(d)};a.on_delete=function(b){var c=a(b.target).closest("li"),e=c[0].innerText,h=!1,i,k,l="";if(c.hasClass("directory")){h=!0;k=d("folder_string");l=d("delete_folder")}else{k=d("activity_string")}i="<p class=\"delete-item\">"+k+" "+e+l+"</p>";g({title:d("confirm_delete"),body:i,save_button:d("modal_confirm_delete"),checkbox:!1,next:function next(){var d={};if(!0===h){d={action:"delete_directory",path:c.attr("directory-path"),sesskey:M.cfg.sesskey}}else if(c.hasClass("activity")){d={action:"delete",id:c.attr("id").match(/(\d+)$/)[1],sesskey:M.cfg.sesskey}}var e=o();a.post(f("rest"),d,function(){q()}).fail(function(a){j(a)}).always(function(){e.hide()});b.stopPropagation()}})};a.on_restore=function(b){var c=a(b.target).closest("li"),d=null;if(c.hasClass("directory")){d=c.attr("directory-path");y.is_directory=!0}else if(c.hasClass("activity")){d=c.attr("id").match(/(\d+)$/)[1];y.is_directory=!1}y.show(d)};a.on_section_backup=function(a,b,c,e){i({action:"is_userdata_copyable_section",sectionid:a,sectionnumber:b,courseid:c},e,d("confirm_backup_section"),!0)};a.init_bulk_delete=function(b){var c=u.find(".editing_bulkdelete");if(c.length){if(b){c.attr("role","menuitem").addClass("dropdown-item menu-action");c.append(a("<span class='menu-action-text'/>").append(c.attr("title")));u.find(".menubar .dropdown .dropdown-menu").append(c)}else{u.find(".header .commands").append(c)}}};a.init_help_icon=function(a){var b=u.find(".header-commands > .help-icon");if(a){u.find(".header-commands").parent().css("display","block")}else{u.find(".header .commands").append(b)}};a.init_block_header=function(){var b=k();a.init_bulk_delete(b);a.init_help_icon(b)};a.init_item_tree=function(){function b(b,c){var d=a(b),e=d.find(".commands").first();a.each(c,function(b,c){var d=n(c);d.on("click",function(b){a["on_"+c](b)});e.append(d)},this)}var c=["movedir","move","delete"];if(v){c.push("restore")}var d=["delete","restore"];u.find("li.activity").each(function(a,d){b(d,c)});u.find("li.directory").each(function(a,c){b(c,d)});w.init()};a.init_activity_commands=function(){a(document).ajaxComplete(function(b,d,e){var f=e.url,g=f.lastIndexOf("="),h=f.substring(g+1);if("core_course_edit_module"===h||"core_course_get_module"===h){var i=JSON.parse(e.data),j=i[0].args.action;if("delete"===j){return}setTimeout(function(){var b=i[0].args.id,d=a("#module-"+b);c(d);if("duplicate"===j){var e=d.next();c(e)}},1)}});function b(){var b=a("<a href=\"javascript:void(0)\" class=\"add-to-sharing-cart\" />").append(a("<i class=\"fa fa-shopping-basket icon\"></i>")).attr("title",d("backup"));return b}function c(c){var e=c[0].className,f=e.substr(e.indexOf("modtype_")+8),g=d("activity_string");if("label"!==f){g=a(".activity#"+c[0].id).find(".mod-indent-outer .activityinstance span.instancename").html()}var h=b();h.on("click",function(b){a.on_backup(b,g)});var i=c.find(".action-menu.section-cm-edit-actions").parent(".actions");i.append(h)}function e(d){var e=d.find(".section_action_menu").data("sectionid"),f=parseInt((d.attr("id")+"").match(/\d+/)[0]),g=d.attr("aria-label"),i=a("body[id$=flexsections]").length;if(i&&("undefined"==typeof e||null===e)){e=d.data("section-id")}var j=parseInt((a("body").attr("class")+"").match(/course-([0-9]*)( |$)/)[1]),k=b();k.on("click",function(){var b=h(d);g=""!==b?b:g;a.on_section_backup(e,f,j,g)});var l=d.find("h3.sectionname").first().find("a").last(),m=d.find("h3.sectionname .inplaceeditable").first();if(m.length){l=m}if(i&&0===f){l=d.find("> .controls");l.prepend(k)}else{k.insertAfter(l)}var n="li.activity";if(i){n="li.activity.activity-section-"+e}var o=d.find(n);a(o).each(function(){c(a(this))})}a("body.editing .course-content li.section").each(function(){e(a(this))})};a.init=function(){M.str.block_sharing_cart.pluginname=this.get_plugin_name();a.init_block_header();a.init_item_tree();a.init_activity_commands()};var z=a("<i/>").addClass("spinner fa fa-3x fa-circle-o-notch fa-spin");a("div#sharing-cart-spinner-modal div.spinner-container").prepend(z);a.init()});a(".copy_section").on("click",function(){var b=a(".section-dropdown option:selected"),c=b.data("section-id"),d=b.data("section-number"),e=b.data("course-id"),f=b.data("section-name");a.on_section_backup(c,d,e,f)})}}});
//# sourceMappingURL=script.min.js.map
